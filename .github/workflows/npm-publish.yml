name: CI & Publish (No Tests - Public)
on:
  push:
    branches: [main]   # ç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼ï¼ˆç”¨æ–¼ CI æª¢æŸ¥ï¼‰
    tags: ['v*']       # ç•¶æ¨é€ä»¥ v é–‹é ­çš„ tag æ™‚è§¸ç™¼ï¼ˆç”¨æ–¼ç™¼å¸ƒï¼‰
  pull_request:
    branches: [main]   # ç•¶å»ºç«‹ PR åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼ï¼ˆç”¨æ–¼ CI æª¢æŸ¥ï¼‰
  workflow_dispatch:   # å…è¨±åœ¨ GitHub UI æ‰‹å‹•è§¸ç™¼æ­¤ workflow

jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu æœ€æ–°ç‰ˆæœ¬ä½œç‚ºåŸ·è¡Œç’°å¢ƒ
    steps:
      - uses: actions/checkout@v4  # ä¸‹è¼‰å°ˆæ¡ˆç¨‹å¼ç¢¼åˆ°åŸ·è¡Œç’°å¢ƒ
      # ğŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸ï¼ˆå®‰å…¨æ–¹å¼ï¼‰
      - name: Debug Environment Variables (Safe)
        run: |
          echo "=== æª¢æŸ¥åŸºæœ¬ç’°å¢ƒè®Šæ•¸ ==="
          echo "NODE_VERSION: $(node --version)"
          echo "NPM_VERSION: $(npm --version)"
          echo "YARN_VERSION: $(yarn --version)"
          echo "GITHUB_REF: $GITHUB_REF"
          echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
          echo ""
          
          echo "=== æª¢æŸ¥ npm é…ç½® ==="
          echo "NPM_CONFIG_REGISTRY: $NPM_CONFIG_REGISTRY"
          echo "NPM_CONFIG_USERCONFIG: $NPM_CONFIG_USERCONFIG"
          echo ""
          
          echo "=== æª¢æŸ¥ NODE_AUTH_TOKEN æ˜¯å¦å­˜åœ¨ ==="
          if [ -n "$NODE_AUTH_TOKEN" ]; then
            echo "âœ… NODE_AUTH_TOKEN å·²è¨­å®š"
            echo "TOKEN é•·åº¦: ${#NODE_AUTH_TOKEN} å­—å…ƒ"
            echo "TOKEN é–‹é ­: ${NODE_AUTH_TOKEN:0:8}..."  # åªé¡¯ç¤ºå‰8å€‹å­—å…ƒ
          else
            echo "âŒ NODE_AUTH_TOKEN æœªè¨­å®šæˆ–ç‚ºç©º"
          fi
          echo ""
          
          echo "=== æª¢æŸ¥ .npmrc æª”æ¡ˆ ==="
          if [ -f ~/.npmrc ]; then
            echo "âœ… ~/.npmrc æª”æ¡ˆå­˜åœ¨"
            echo "æª”æ¡ˆå…§å®¹ï¼ˆéš±è—æ•æ„Ÿè³‡è¨Šï¼‰:"
            sed 's/_authToken=.*/_authToken=***HIDDEN***/g' ~/.npmrc
          else
            echo "âŒ ~/.npmrc æª”æ¡ˆä¸å­˜åœ¨"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node.js with Yarn cache
        uses: actions/setup-node@v4  # è¨­å®š Node.js ç’°å¢ƒ
        with:
          node-version: 20                              # ä½¿ç”¨ Node.js 20 ç‰ˆæœ¬
          cache: 'yarn'                                 # å•Ÿç”¨ Yarn å¿«å–ï¼ŒåŠ é€Ÿå¾ŒçºŒå®‰è£
          registry-url: 'https://registry.npmjs.org'   # è¨­å®š npm registry åœ°å€

      - name: Install dependencies
        run: yarn install --frozen-lockfile  # å®‰è£ä¾è³´ï¼Œ--frozen-lockfile ç¢ºä¿ä½¿ç”¨ lock æª”æ¡ˆä¸­çš„ç¢ºåˆ‡ç‰ˆæœ¬

      - name: Build package
        run: yarn build  # åŸ·è¡Œå»ºç½®å‘½ä»¤ï¼Œå°‡å°ˆæ¡ˆç·¨è­¯æˆå¯ç™¼å¸ƒçš„æ ¼å¼

  publish:
    needs: build  # æ­¤ job å¿…é ˆç­‰ build job æˆåŠŸå®Œæˆå¾Œæ‰èƒ½åŸ·è¡Œ
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu æœ€æ–°ç‰ˆæœ¬ä½œç‚ºåŸ·è¡Œç’°å¢ƒ
    # åªæœ‰åœ¨æ¨é€ tag æˆ–æ‰‹å‹•è§¸ç™¼æ™‚æ‰åŸ·è¡Œç™¼å¸ƒ
    if: github.ref_type == 'tag' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4  # ä¸‹è¼‰å°ˆæ¡ˆç¨‹å¼ç¢¼åˆ°åŸ·è¡Œç’°å¢ƒ

      - name: Setup Node.js for publishing
        uses: actions/setup-node@v4  # é‡æ–°è¨­å®š Node.js ç’°å¢ƒï¼ˆæ¯å€‹ job éƒ½æ˜¯ç¨ç«‹çš„ï¼‰
        with:
          node-version: 20                              # ä½¿ç”¨ Node.js 20 ç‰ˆæœ¬
          cache: 'yarn'                                 # å•Ÿç”¨ Yarn å¿«å–
          registry-url: 'https://registry.npmjs.org'   # è¨­å®š npm registry åœ°å€

      - name: Install dependencies
        run: yarn install --frozen-lockfile  # é‡æ–°å®‰è£ä¾è³´ï¼ˆå› ç‚ºæ¯å€‹ job ç’°å¢ƒéƒ½æ˜¯ç¨ç«‹çš„ï¼‰

      - name: Build package
        run: yarn build  # é‡æ–°å»ºç½®å¥—ä»¶

      - name: Publish to npm (Public Package)
        run: npm publish --access public  # ç™¼å¸ƒåˆ° npmï¼Œ--access public è¡¨ç¤ºå…¬é–‹å¥—ä»¶
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}  # ä½¿ç”¨ GitHub Secrets ä¸­çš„ NPM_TOKEN é€²è¡Œèº«ä»½é©—è­‰
